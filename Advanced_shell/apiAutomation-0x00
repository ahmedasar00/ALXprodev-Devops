#!/bin/bash
#
# Objective: Automate API request to the PokÃ©mon API for Pikachu (ID 25).
# Saves the successful JSON response to data.json.
# Logs any request failure (network or HTTP error) to errors.txt.

# Configuration
API_URL="https://pokeapi.co/api/v2/pokemon/pikachu"
DATA_FILE="data.json"
ERROR_FILE="errors.txt"

# 1. Clear previous error log before starting
> "$ERROR_FILE"

# 2. Make the API request
# -s: Silent mode (removes progress bar)
# -w "\n%{http_code}": Write the HTTP status code on a new line after the body
# The entire response (body + HTTP code) is captured in the RESPONSE variable.
RESPONSE=$(curl -s -w "\n%{http_code}" "$API_URL")
CURL_STATUS=$? # Capture the curl exit status (0 for success, non-zero for network error)

# 3. Separate the response body and the HTTP status code
# The last line is the HTTP code
HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
# The remaining lines are the body
BODY=$(echo "$RESPONSE" | head -n -1)

# --- Error Handling ---

# Check for Network/Curl Error
if [ $CURL_STATUS -ne 0 ]; then
    # Log network failure
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] FATAL: Network/Curl Error (Exit Code $CURL_STATUS) while fetching $API_URL" > "$ERROR_FILE"
    # Clear the data file to ensure it's empty on critical failure
    > "$DATA_FILE"
    exit 1
fi

# Check for HTTP Error (4xx or 5xx)
# The regex checks if the code starts with 4 or 5 followed by two digits
if [[ "$HTTP_CODE" =~ ^[45][0-9][0-9]$ ]]; then
    # Log HTTP failure
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] ERROR: HTTP Status Code $HTTP_CODE fetching $API_URL" > "$ERROR_FILE"
    echo "Response Body (Saved to data.json):" >> "$ERROR_FILE"
    # Append the error response body to errors.txt for debugging
    echo "$BODY" >> "$ERROR_FILE"
    # Save the error response to data.json
    echo "$BODY" > "$DATA_FILE"
    exit 1
fi

# --- Success Case ---

# Save the successful JSON response body to data.json
echo "$BODY" > "$DATA_FILE"

# The script exits with a successful status (0) by default if it reaches here.
exit 0